<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel - Andrés Raíz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="panel">
    <img src="assets/logo.png" class="logo" alt="Logo"/>
    <h2>Bienvenido, <span id="nombre"></span></h2>

    <div class="info-box">
      <p><strong>Cédula:</strong> <span id="cedula"></span></p>
      <p><strong>Cargo:</strong> <span id="cargo"></span></p>
      <p><strong>Fecha de ingreso:</strong> <span id="ingreso"></span></p>
      <p><strong>Vacaciones acumuladas:</strong> <span id="vacaciones"></span> días</p>
    </div>

    <div class="btn-group">
      <button onclick="descargarColilla()">Ver colilla de este mes</button>
      <button onclick="generarCertificado()">Generar certificado laboral</button>
      <button onclick="cerrarSesion()">Cerrar sesión</button>
    </div>

    <iframe id="visor" style="display:none;" width="100%" height="500px"></iframe>
  </div>

  <script>
    const empleado = JSON.parse(localStorage.getItem('empleado'));
    if (!empleado) {
      window.location.href = "index.html";
    } else {
      document.getElementById('nombre').innerText = empleado.nombre;
      document.getElementById('cedula').innerText = empleado.cedula;
      document.getElementById('cargo').innerText = empleado.cargo;
      document.getElementById('ingreso').innerText = empleado.ingreso;

      // Cálculo de vacaciones automáticas
      const fechaIngreso = new Date(empleado.ingreso);
      const hoy = new Date();
      const años = hoy.getFullYear() - fechaIngreso.getFullYear();
      const meses = hoy.getMonth() - fechaIngreso.getMonth();
      const totalMeses = (años * 12) + meses;
      const diasVacaciones = Math.floor((15 / 12) * totalMeses) - (empleado.vacaciones || 0);
      document.getElementById('vacaciones').innerText = diasVacaciones;
    }

    function descargarColilla() {
      const mes = new Date().toISOString().slice(0, 7);
      const path = `colillas/${empleado.cedula}/${mes}.pdf`;
      document.getElementById("visor").src = path;
      document.getElementById("visor").style.display = "block";
    }

    function cerrarSesion() {
      localStorage.removeItem('empleado');
      window.location.href = "index.html";
    }
  </script>
 <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
function numeroATexto(valor) {
  const formatter = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 });
  const enLetras = new Intl.NumberFormat('es', { style: 'unit', unit: 'long' }).format(valor);
  return formatter.format(valor) + " (" + valorEnLetras(valor).toUpperCase() + ")";
}

function valorEnLetras(num) {
  // Versión simple. Podemos reemplazar por librería si quieres precisión legal
  const formatter = new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    maximumFractionDigits: 0
  });
  return formatter.format(num);
}

async function generarCertificado() {
  const { nombre, cedula, cargo, ingreso, salario, rodamiento, comisiones } = empleado;
  const hoy = new Date();
  const fechaActual = hoy.toLocaleDateString("es-CO", { year: 'numeric', month: 'long', day: 'numeric' });

  const existingPdfBytes = await fetch("certificado_base.pdf").then(res => res.arrayBuffer());
  const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
  const pages = pdfDoc.getPages();
  const firstPage = pages[0];
  const { width, height } = firstPage.getSize();
  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

  // Datos básicos
  firstPage.drawText(nombre, { x: 160, y: height - 245, size: 11, font, color: PDFLib.rgb(0, 0, 0) });
  firstPage.drawText(cedula, { x: 170, y: height - 262, size: 11, font, color: PDFLib.rgb(0, 0, 0) });
  firstPage.drawText(cargo, { x: 175, y: height - 278, size: 11, font, color: PDFLib.rgb(0, 0, 0) });
  firstPage.drawText(ingreso, { x: 235, y: height - 293, size: 11, font, color: PDFLib.rgb(0, 0, 0) });
  firstPage.drawText(fechaActual, { x: 215, y: height - 337, size: 11, font, color: PDFLib.rgb(0, 0, 0) });

  // Salario y otros valores
  const textoSalario = `Devenga un salario mensual de $${salario.toLocaleString('es-CO')} (${valorEnLetras(salario).toUpperCase()}), más auxilio de rodamiento de $${rodamiento.toLocaleString('es-CO')} y comisiones mensuales promedio de $${comisiones.toLocaleString('es-CO')}.`;

  firstPage.drawText(textoSalario, {
    x: 60,
    y: height - 310,
    size: 11,
    font,
    color: PDFLib.rgb(0, 0, 0),
    maxWidth: 480,
    lineHeight: 14
  });

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const visor = document.getElementById('visor');
  visor.src = url;
  visor.style.display = 'block';
}
</script>


</body>
</html>
