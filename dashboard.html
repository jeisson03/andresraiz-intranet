<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel - Andrés Raíz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="panel">
    <img src="assets/logo.png" class="logo" alt="Logo"/>
    <h2>Bienvenido, <span id="nombre"></span></h2>

    <div class="info-box">
      <p><strong>Cédula:</strong> <span id="cedula"></span></p>
      <p><strong>Cargo:</strong> <span id="cargo"></span></p>
      <p><strong>Fecha de ingreso:</strong> <span id="ingreso"></span></p>
      <p><strong>Vacaciones acumuladas:</strong> <span id="vacaciones"></span> días</p>
    </div>

    <div class="btn-group">
      <button onclick="descargarColilla()">Ver colilla de este mes</button>
      <button onclick="generarCertificado()">Generar certificado laboral</button>
      <button onclick="cerrarSesion()">Cerrar sesión</button>
    </div>

    <iframe id="visor" style="display:none;" width="100%" height="500px"></iframe>
  </div>

  <script>
    const empleado = JSON.parse(localStorage.getItem('empleado'));
    if (!empleado) {
      window.location.href = "index.html";
    } else {
      document.getElementById('nombre').innerText = empleado.nombre;
      document.getElementById('cedula').innerText = empleado.cedula;
      document.getElementById('cargo').innerText = empleado.cargo;
      document.getElementById('ingreso').innerText = empleado.ingreso;

      const fechaIngreso = new Date(empleado.ingreso);
      const hoy = new Date();
      const años = hoy.getFullYear() - fechaIngreso.getFullYear();
      const meses = hoy.getMonth() - fechaIngreso.getMonth();
      const totalMeses = (años * 12) + meses;
      const diasVacaciones = Math.floor((15 / 12) * totalMeses) - (empleado.vacaciones || 0);
      document.getElementById('vacaciones').innerText = diasVacaciones;
    }

    function descargarColilla() {
      const mes = new Date().toISOString().slice(0, 7);
      const path = `colillas/${empleado.cedula}/${mes}.pdf`;
      document.getElementById("visor").src = path;
      document.getElementById("visor").style.display = "block";
    }

    function cerrarSesion() {
      localStorage.removeItem('empleado');
      window.location.href = "index.html";
    }
  </script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
  function numeroALetras(num) {
    const unidades = ['CERO','UNO','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE'];
    const especiales = ['DIEZ','ONCE','DOCE','TRECE','CATORCE','QUINCE','DIECISÉIS','DIECISIETE','DIECIOCHO','DIECINUEVE'];
    const decenas = ['','DIEZ','VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA'];
    const centenas = ['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS','NOVECIENTOS'];

    function convertirGrupo(n) {
      if (n === 0) return '';
      if (n === 100) return 'CIEN';
      let c = Math.floor(n / 100);
      let d = Math.floor((n % 100) / 10);
      let u = n % 10;
      let texto = '';
      if (c) texto += centenas[c] + ' ';
      if (d === 1 && u > 0) {
        texto += especiales[u] + ' ';
      } else {
        if (d) texto += decenas[d] + ' ';
        if (u && d !== 1) texto += unidades[u] + ' ';
      }
      return texto.trim();
    }

    let miles = Math.floor(num / 1000);
    let resto = num % 1000;
    let texto = '';
    if (miles === 1) texto += 'MIL ';
    else if (miles > 1) texto += convertirGrupo(miles) + ' MIL ';
    texto += convertirGrupo(resto);
    return texto.trim() + ' PESOS COLOMBIANOS';
  }

  function formatoPesos(num) {
    return '$' + num.toLocaleString('es-CO');
  }

  async function generarCertificado() {
    const { nombre, cedula, cargo, ingreso, salario, transporte, rodamiento, comisiones } = empleado;
    const hoy = new Date();
    const fechaActual = hoy.toLocaleDateString("es-CO", { year: 'numeric', month: 'long', day: 'numeric' });

    const texto = `Sabaneta, ${fechaActual}

A QUIEN PUEDA INTERESAR

ANDRÉS RAÍZ INMOBILIARIA S.A.S con NIT: 901524934 certifica que el señor
${nombre} identificado con cedula de ciudadanía No. ${cedula} labora en nuestra compañía desde el ${ingreso} hasta la fecha bajo el cargo de ${cargo} mediante un contrato a término indefinido, con un salario básico de:
${numeroALetras(salario)} (${formatoPesos(salario)}) CON AUXILIO DE TRANSPORTE EQUIVALENTE A ${numeroALetras(transporte)} (${formatoPesos(transporte)}), UN AUXILIO DE RODAMIENTO EQUIVALENTE A ${numeroALetras(rodamiento)} (${formatoPesos(rodamiento)}) MÁS COMISIONES NO CONSTITUTIVAS DE SALARIO CON PROMEDIO DE ${numeroALetras(comisiones)} (${formatoPesos(comisiones)})

Cualquier información o requerimiento adicional con gusto será atendido por medio del correo electrónico servicio@andresraiz.com o los teléfonos 358 85 64 y 3245366761`;

    const existingPdfBytes = await fetch("certificado_base.pdf").then(res => res.arrayBuffer());
    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const page = pdfDoc.getPages()[0];
    const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

    page.drawText(texto, {
      x: 60,
      y: 680,
      size: 10,
      font,
      lineHeight: 14,
      maxWidth: 480,
      color: PDFLib.rgb(0, 0, 0),
    });

    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const visor = document.getElementById('visor');
    visor.src = url;
    visor.style.display = 'block';
  }
  </script>
</body>
</html>
