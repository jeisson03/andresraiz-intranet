<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel - Andrés Raíz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="panel">
    <img src="assets/logo.png" class="logo" alt="Logo"/>
    <h2>Bienvenido, <span id="nombre"></span></h2>

    <div class="info-box">
      <p><strong>Cédula:</strong> <span id="cedula"></span></p>
      <p><strong>Cargo:</strong> <span id="cargo"></span></p>
      <p><strong>Fecha de ingreso:</strong> <span id="ingreso"></span></p>
      <p><strong>Días disfrutados:</strong> <span id="vacacionesTomadas"></span></p>
      <p><strong>Días disponibles:</strong> <span id="vacacionesDisponibles"></span></p>
    </div>

    <div class="btn-group">
      <button onclick="descargarColilla()">Ver colilla de este mes</button>
      <button onclick="generarCertificado()">Generar certificado laboral</button>
      <button onclick="cerrarSesion()">Cerrar sesión</button>
    </div>

    <iframe id="visor" style="display:none;" width="100%" height="500px"></iframe>
  </div>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    const empleado = JSON.parse(localStorage.getItem('empleado'));
    if (!empleado) {
      window.location.href = "index.html";
    } else {
      document.getElementById('nombre').innerText = empleado.nombre;
      document.getElementById('cedula').innerText = empleado.cedula;
      document.getElementById('cargo').innerText = empleado.cargo;
      const fechaLegible = new Date(empleado.ingreso).toLocaleDateString('es-CO', { day: 'numeric', month: 'long', year: 'numeric' });
      document.getElementById('ingreso').innerText = fechaLegible;

      const fechaIngreso = new Date(empleado.ingreso);
      const hoy = new Date();
      const años = hoy.getFullYear() - fechaIngreso.getFullYear();
      const meses = hoy.getMonth() - fechaIngreso.getMonth();
      const totalMeses = (años * 12) + meses;
      const acumuladas = Math.floor((15 / 12) * totalMeses);
      const tomadas = Number(empleado.vacaciones) || 0;
      const disponibles = Math.max(acumuladas - tomadas, 0);
      document.getElementById('vacacionesTomadas').innerText = tomadas;
      document.getElementById('vacacionesDisponibles').innerText = disponibles;
    }

    function descargarColilla() {
      const mes = new Date().toISOString().slice(0, 7);
      const path = `colillas/${empleado.cedula}/${mes}.pdf`;
      const visor = document.getElementById("visor");
      visor.removeAttribute('src');
      visor.style.display = "block";
      setTimeout(() => visor.src = path, 100);
    }

    function cerrarSesion() {
      localStorage.removeItem('empleado');
      window.location.href = "index.html";
    }

    function numeroATexto(valor) {
      return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(valor);
    }

    function enLetrasColombianas(numero) {
      const UNIDADES = ['CERO','UNO','DOS','TRES','CUATRO','CINCO','SEIS','SIETE','OCHO','NUEVE'];
      const DECENAS = ['','DIEZ','VEINTE','TREINTA','CUARENTA','CINCUENTA','SESENTA','SETENTA','OCHENTA','NOVENTA'];
      const CENTENAS = ['','CIENTO','DOSCIENTOS','TRESCIENTOS','CUATROCIENTOS','QUINIENTOS','SEISCIENTOS','SETECIENTOS','OCHOCIENTOS','NOVECIENTOS'];

      function convertir(num) {
        if (num === 0) return 'CERO';
        if (num === 100) return 'CIEN';

        let resultado = '';
        if (num >= 1000000) {
          resultado += convertir(Math.floor(num / 1000000)) + ' MILLONES ';
          num %= 1000000;
        }
        if (num >= 1000) {
          if (Math.floor(num / 1000) === 1) {
            resultado += 'MIL ';
          } else {
            resultado += convertir(Math.floor(num / 1000)) + ' MIL ';
          }
          num %= 1000;
        }
        if (num >= 100) {
          resultado += CENTENAS[Math.floor(num / 100)] + ' ';
          num %= 100;
        }
        if (num >= 10) {
          if (num >= 11 && num <= 15) {
            const especiales = ['ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE'];
            return resultado + especiales[num - 11] + ' ';
          }
          resultado += DECENAS[Math.floor(num / 10)] + ' ';
          num %= 10;
        }
        if (num > 0) {
          resultado += UNIDADES[num] + ' ';
        }
        return resultado.trim();
      }

      return convertir(numero) + ' PESOS';
    }

    async function generarCertificado() {
      const { nombre, cedula, cargo, ingreso, salario, transporte, rodamiento, comisiones } = empleado;
      const hoy = new Date();
      const fechaActual = hoy.toLocaleDateString("es-CO", { year: 'numeric', month: 'long', day: 'numeric' });
      const texto = `Sabaneta, ${fechaActual}\n\n\n\nA QUIEN PUEDA INTERESAR\n\n\n\nANDRÉS RAÍZ INMOBILIARIA S.A.S con NIT: 901524934 certifica que el señor\n${nombre} identificado con cedula de ciudadanía No. ${cedula} labora en\nnuestra compañía desde el ${new Date(ingreso).toLocaleDateString('es-CO', { day: 'numeric', month: 'long', year: 'numeric' })} hasta la fecha bajo el cargo de ${cargo}\nmediante un contrato a término indefinido, con un salario básico de:\n\n${enLetrasColombianas(salario).toUpperCase()} (${numeroATexto(salario)}), CON AUXILIO DE TRANSPORTE EQUIVALENTE A\n${enLetrasColombianas(transporte).toUpperCase()} (${numeroATexto(transporte)}), UN AUXILIO DE RODAMIENTO\nEQUIVALENTE A ${enLetrasColombianas(rodamiento).toUpperCase()} (${numeroATexto(rodamiento)}) MÁS COMISIONES NO CONSTITUTIVAS DE SALARIO CON\nPROMEDIO DE ${enLetrasColombianas(comisiones).toUpperCase()} (${numeroATexto(comisiones)})\n\nCualquier información o requerimiento adicional con gusto será atendido por medio del\ncorreo electrónico servicio@andresraiz.com o los teléfonos 358 85 64 y 3245366761`;

      const existingPdfBytes = await fetch("certificado_base.pdf").then(res => res.arrayBuffer());
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const page = pdfDoc.getPages()[0];
      const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

      page.drawText(texto, {
        x: 50,
        y: 620,
        size: 10,
        font,
        lineHeight: 14,
        color: PDFLib.rgb(0, 0, 0),
        maxWidth: 500,
      });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const visor = document.getElementById('visor');
      visor.removeAttribute('src');
      visor.style.display = 'block';
      setTimeout(() => visor.src = url, 100);
    }
  </script>
</body>
</html>
